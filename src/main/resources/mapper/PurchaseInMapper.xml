<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chengxin.sync_job.dao.IPurchaseInDao">

    <!--采购入库主表字段-->
    <sql id="PurchaseInParentColumn">
        uniqueId,
        bill_type,
        creator_code,
        ware_code,
        corp_code,
        operate_date,
        special_code
    </sql>

    <!--采购入库主表字段-->
    <sql id="PurchaseInChildColumn">
        mater_code,
        floor_code,
        PRICE_UNIT_amt,
        AVEPRICE
    </sql>

    <!--主表映射-->
    <resultMap id="BaseParentResultMap" type="com.chengxin.sync_job.domain.PurchaseInParentEntity">
        <result column="bill_type" property="billType"/>
        <result column="creator_code" property="creatorCode"/>
        <result column="ware_code" property="wareCode"/>
        <result column="corp_code" property="corpCode"/>
        <result column="operate_date" property="operateDate"/>
        <result column="special_code" property="specialCode"/>
        <collection property="purchaseInChilds" column="uniqueId" javaType="ArrayList"
                    ofType="com.chengxin.sync_job.domain.PurchaseInChildEntity"
                    select="com.chengxin.sync_job.dao.IPurchaseInDao.findPurchaseInChildByParentId">
        </collection>
    </resultMap>

    <!--子表映射-->
    <resultMap id="BaseChildResultMap" type="com.chengxin.sync_job.domain.PurchaseInChildEntity">
        <result column="mater_code" property="materCode"/>
        <result column="floor_code" property="floorCode"/>
        <result column="PRICE_UNIT_amt" property="priceUnitAmt"/>
        <result column="AVEPRICE" property="avePrice"/>
    </resultMap>

    <!--查询未传输至用友的采购入库数据-->
    <select id="findPurchaseInParentNotTransfer" resultMap="BaseParentResultMap">
        SELECT * FROM (
          SELECT
            <include refid="PurchaseInParentColumn"/>,
            ROW_NUMBER() OVER(ORDER BY operate_date DESC) AS RowId
          FROM sgRem_InStorageHistory
          WHERE status != 1 OR status IS NULL
        ) as b
        WHERE RowId BETWEEN 0 AND 10
    </select>

    <!--根据主表id查询字表数据-->
    <select id="findPurchaseInChildByParentId" parameterType="java.lang.String" resultMap="BaseChildResultMap
">
        SELECT
          <include refid="PurchaseInChildColumn"/>
        FROM sgRem_InStorageHistoryD
        WHERE masterid = #{parentId}
    </select>
</mapper>